# 📖 图片翻页视频生成器

将多张图片生成3D翻书效果视频，支持透视变形、书本厚度、光影渐变等真实翻书效果。

## ✨ 核心特性

### 1. 3D翻书效果
- **透视变形**：使用Canvas transform实现真实的3D旋转效果
- **书本厚度**：在翻页边缘显示白色侧边，模拟纸张厚度
- **光影渐变**：多层阴影系统（翻页投影、光影效果、深度阴影）
- **缓动动画**：使用ease-in-out cubic让翻页更自然流畅

### 2. 素材管理
- **顺序切换**：严格按照 1→2→3→...→n 的顺序翻页，无回跳、无重复
- **索引管理**：内置素材索引管理器，确保每张图只显示一次
- **动画锁定**：翻页动画执行期间禁止素材切换，避免错乱

### 3. 用户功能
- **拖拽上传**：支持点击或拖拽上传多张图片
- **顺序调整**：可拖拽调整图片顺序，预览完整图片内容
- **参数配置**：可自定义停留时间、翻页时长、分辨率、帧率
- **视频导出**：生成WebM格式视频，支持下载

## 🚀 使用方法

### 1. 上传图片
- 点击上传区域或拖拽图片文件
- 支持JPG、PNG等常见图片格式
- 建议上传3-10张图片

### 2. 调整顺序
- 拖拽图片卡片可调整顺序
- 预览图显示完整图片内容
- 页码自动更新

### 3. 配置参数
- **停留时间**：每张图片显示的时长（默认2秒）
- **翻页时长**：翻页动画的时长（默认0.5秒）
- **视频尺寸**：默认1080x1440（3:4竖屏）
- **帧率**：24/30/60 FPS可选（默认30）

### 4. 生成视频
- 点击"生成视频"按钮
- 等待渲染完成（进度条显示）
- 预览并下载视频

## 🔧 可配置参数

### 在代码中可调整的参数：

```javascript
// 书本厚度（app.js 第340行左右）
const bookThickness = Math.min(width, height) * 0.015; // 默认1.5%

// 阴影透明度（app.js 第370行左右）
const shadowOpacity = Math.sin(angle) * 0.6; // 默认0.6

// 翻页边缘阴影宽度（app.js 第375行左右）
const shadowWidth = width * 0.3; // 默认30%

// 翻起页面阴影（app.js 第470行左右）
const flipShadowOpacity = Math.abs(Math.sin(angle)) * 0.5; // 默认0.5
```

## 📋 测试说明

### 测试步骤：
1. 准备至少3张测试图片（建议使用不同颜色或内容，便于区分）
2. 按顺序上传图片（例如：红色、绿色、蓝色）
3. 点击生成视频
4. 观察视频效果，确认：
   - ✅ 第1张图停留 → 翻页动画 → 第2张图停留
   - ✅ 第2张图停留 → 翻页动画 → 第3张图停留
   - ✅ 无回跳、无重复、无闪烁
   - ✅ 翻页过程中能看到下一张图的内容
   - ✅ 透视变形平滑，无拉伸失真

### 预期效果：
- **素材顺序**：严格按照上传顺序依次翻页
- **翻页逻辑**：翻起的页面背面显示下一张图
- **视觉效果**：流畅的3D翻书动画，带真实光影

## 🐛 故障修正记录

### 修正前的问题：
1. **素材切换错乱**：翻页后回跳到第1张，或随机跳图
2. **翻页效果杂乱**：页面闪烁、拉伸失真、层级错乱

### 修正方案：
1. **素材索引管理器**：
   - 新增 `currentIndex` 变量追踪当前素材
   - 严格控制索引更新时机（仅在翻页动画完成后）
   - 动画执行期间锁定索引，避免冲突

2. **视频渲染逻辑重构**：
   - 明确渲染顺序：图1停留 → 翻页1→2 → 图2停留 → 翻页2→3 → ...
   - 确保每张图只显示一次停留帧
   - 翻页动画正确衔接前后两张图

3. **视觉效果优化**：
   - 使用缓动函数消除生硬感
   - 严格按层级顺序渲染（背景→阴影→厚度→翻起页→静止页）
   - 优化透视变形算法，避免失真
   - 添加裁剪区域，消除闪烁

## 📝 技术细节

### 渲染流程：
```
1. 背景层：绘制下一页（img2）
2. 阴影层：绘制翻页投影
3. 厚度层：绘制书本侧边（白色）
4. 翻起页：绘制当前页翻起部分（带透视变形）
   - 0°~90°：显示当前页正面
   - 90°~180°：显示下一页背面
5. 静止页：绘制当前页未翻起部分
```

### 关键算法：
- **翻页角度**：`angle = easeProgress * π`（0° → 180°）
- **透视宽度**：`perspectiveWidth = originalWidth * |cos(angle)|`
- **翻页位置**：`flipX = width - (width * angle / π)`

## 📱 迁移到微信小程序

### 核心代码可复用部分
1. **图片处理逻辑**：`loadImage()`, `drawImage()` 函数
2. **动画算法**：`drawTransition()` 及相关函数
3. **视频生成流程**：整体流程可参考

### 需要调整的部分
1. **文件上传**：使用 `wx.chooseImage()`
2. **Canvas API**：使用小程序的 Canvas 2D API
3. **视频录制**：使用 `wx.createMediaRecorder()`
4. **文件保存**：使用 `wx.saveVideoToPhotosAlbum()`

## 🎯 后续优化方向

- [ ] 支持左翻书效果（当前仅支持右翻）
- [ ] 添加循环播放选项
- [ ] 支持自定义背景颜色
- [ ] 优化大尺寸图片的渲染性能
- [ ] 支持导出MP4格式
- [ ] 添加背景音乐

## 📄 许可证

MIT License

---

**祝你使用愉快！** 🎉
